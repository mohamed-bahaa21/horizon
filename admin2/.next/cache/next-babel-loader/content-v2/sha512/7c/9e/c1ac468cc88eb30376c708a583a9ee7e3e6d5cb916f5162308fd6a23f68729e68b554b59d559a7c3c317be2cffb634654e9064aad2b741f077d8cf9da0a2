{"ast":null,"code":"import { getWebsiteStats } from 'lib/queries';\nimport { methodNotAllowed, ok, unauthorized } from 'lib/response';\nimport { allowQuery } from 'lib/auth';\nexport default (async (req, res) => {\n  if (req.method === 'GET') {\n    if (!(await allowQuery(req))) {\n      return unauthorized(res);\n    }\n\n    const {\n      id,\n      start_at,\n      end_at,\n      url\n    } = req.query;\n    const websiteId = +id;\n    const startDate = new Date(+start_at);\n    const endDate = new Date(+end_at);\n    const distance = end_at - start_at;\n    const prevStartDate = new Date(+start_at - distance);\n    const prevEndDate = new Date(+end_at - distance);\n    const metrics = await getWebsiteStats(websiteId, startDate, endDate, {\n      url\n    });\n    const prevPeriod = await getWebsiteStats(websiteId, prevStartDate, prevEndDate, {\n      url\n    });\n    const stats = Object.keys(metrics[0]).reduce((obj, key) => {\n      obj[key] = {\n        value: Number(metrics[0][key]) || 0,\n        change: Number(metrics[0][key] - prevPeriod[0][key]) || 0\n      };\n      return obj;\n    }, {});\n    return ok(res, stats);\n  }\n\n  return methodNotAllowed(res);\n});","map":null,"metadata":{},"sourceType":"module"}