{"ast":null,"code":"import { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport React, { useMemo, useState } from 'react';\nimport { FormattedMessage, useIntl } from 'react-intl';\nimport { FixedSizeList } from 'react-window';\nimport firstBy from 'thenby';\nimport Icon from 'components/common/Icon';\nimport Tag from 'components/common/Tag';\nimport Dot from 'components/common/Dot';\nimport FilterButtons from 'components/common/FilterButtons';\nimport NoData from 'components/common/NoData';\nimport { devices } from 'components/messages';\nimport useLocale from 'hooks/useLocale';\nimport useCountryNames from 'hooks/useCountryNames';\nimport { BROWSERS } from 'lib/constants';\nimport Bolt from 'assets/bolt.svg';\nimport Visitor from 'assets/visitor.svg';\nimport Eye from 'assets/eye.svg';\nimport { stringToColor } from 'lib/format';\nimport { dateFormat } from 'lib/date';\nimport styles from './RealtimeLog.module.css';\nconst TYPE_ALL = 0;\nconst TYPE_PAGEVIEW = 1;\nconst TYPE_SESSION = 2;\nconst TYPE_EVENT = 3;\nconst TYPE_ICONS = {\n  [TYPE_PAGEVIEW]: /*#__PURE__*/_jsx(Eye, {}),\n  [TYPE_SESSION]: /*#__PURE__*/_jsx(Visitor, {}),\n  [TYPE_EVENT]: /*#__PURE__*/_jsx(Bolt, {})\n};\nexport default function RealtimeLog({\n  data,\n  websites,\n  websiteId\n}) {\n  const intl = useIntl();\n  const {\n    locale\n  } = useLocale();\n  const countryNames = useCountryNames(locale);\n  const {\n    0: filter,\n    1: setFilter\n  } = useState(TYPE_ALL);\n  const logs = useMemo(() => {\n    const {\n      pageviews,\n      sessions,\n      events\n    } = data;\n    const logs = [...pageviews, ...sessions, ...events].sort(firstBy('created_at', -1));\n\n    if (filter) {\n      return logs.filter(row => getType(row) === filter);\n    }\n\n    return logs;\n  }, [data, filter]);\n  const uuids = useMemo(() => {\n    return data.sessions.reduce((obj, {\n      session_id,\n      session_uuid\n    }) => {\n      obj[session_id] = session_uuid;\n      return obj;\n    }, {});\n  }, [data]);\n  const buttons = [{\n    label: /*#__PURE__*/_jsx(FormattedMessage, {\n      id: \"label.all\",\n      defaultMessage: \"All\"\n    }),\n    value: TYPE_ALL\n  }, {\n    label: /*#__PURE__*/_jsx(FormattedMessage, {\n      id: \"metrics.views\",\n      defaultMessage: \"Views\"\n    }),\n    value: TYPE_PAGEVIEW\n  }, {\n    label: /*#__PURE__*/_jsx(FormattedMessage, {\n      id: \"metrics.visitors\",\n      defaultMessage: \"Visitors\"\n    }),\n    value: TYPE_SESSION\n  }, {\n    label: /*#__PURE__*/_jsx(FormattedMessage, {\n      id: \"metrics.events\",\n      defaultMessage: \"Events\"\n    }),\n    value: TYPE_EVENT\n  }];\n\n  function getType({\n    view_id,\n    session_id,\n    event_id\n  }) {\n    if (event_id) {\n      return TYPE_EVENT;\n    }\n\n    if (view_id) {\n      return TYPE_PAGEVIEW;\n    }\n\n    if (session_id) {\n      return TYPE_SESSION;\n    }\n\n    return null;\n  }\n\n  function getIcon(row) {\n    return TYPE_ICONS[getType(row)];\n  }\n\n  function getWebsite({\n    website_id\n  }) {\n    return websites.find(n => n.website_id === website_id);\n  }\n\n  function getDetail({\n    event_type,\n    event_value,\n    view_id,\n    session_id,\n    url,\n    browser,\n    os,\n    country,\n    device,\n    website_id\n  }) {\n    if (event_type) {\n      return /*#__PURE__*/_jsxs(\"div\", {\n        children: [/*#__PURE__*/_jsx(Tag, {\n          children: event_type\n        }), \" \", event_value]\n      });\n    }\n\n    if (view_id) {\n      var _getWebsite;\n\n      const domain = (_getWebsite = getWebsite({\n        website_id\n      })) === null || _getWebsite === void 0 ? void 0 : _getWebsite.domain;\n      return /*#__PURE__*/_jsx(\"a\", {\n        className: styles.link,\n        href: `//${domain}${url}`,\n        target: \"_blank\",\n        rel: \"noreferrer noopener\",\n        children: url\n      });\n    }\n\n    if (session_id) {\n      var _intl$formatMessage;\n\n      return /*#__PURE__*/_jsx(FormattedMessage, {\n        id: \"message.log.visitor\",\n        defaultMessage: \"Visitor from {country} using {browser} on {os} {device}\",\n        values: {\n          country: /*#__PURE__*/_jsx(\"b\", {\n            children: countryNames[country] || intl.formatMessage({\n              id: 'label.unknown',\n              defaultMessage: 'Unknown'\n            })\n          }),\n          browser: /*#__PURE__*/_jsx(\"b\", {\n            children: BROWSERS[browser]\n          }),\n          os: /*#__PURE__*/_jsx(\"b\", {\n            children: os\n          }),\n          device: /*#__PURE__*/_jsx(\"b\", {\n            children: (_intl$formatMessage = intl.formatMessage(devices[device])) === null || _intl$formatMessage === void 0 ? void 0 : _intl$formatMessage.toLowerCase()\n          })\n        }\n      });\n    }\n  }\n\n  function getTime({\n    created_at\n  }) {\n    return dateFormat(new Date(created_at), 'pp', locale);\n  }\n\n  function getColor(row) {\n    const {\n      session_id\n    } = row;\n    return stringToColor(uuids[session_id] || `${session_id}${getWebsite(row)}`);\n  }\n\n  const Row = ({\n    index,\n    style\n  }) => {\n    var _getWebsite2;\n\n    const row = logs[index];\n    return /*#__PURE__*/_jsxs(\"div\", {\n      className: styles.row,\n      style: style,\n      children: [/*#__PURE__*/_jsx(\"div\", {\n        children: /*#__PURE__*/_jsx(Dot, {\n          color: getColor(row)\n        })\n      }), /*#__PURE__*/_jsx(\"div\", {\n        className: styles.time,\n        children: getTime(row)\n      }), /*#__PURE__*/_jsxs(\"div\", {\n        className: styles.detail,\n        children: [/*#__PURE__*/_jsx(Icon, {\n          className: styles.icon,\n          icon: getIcon(row)\n        }), getDetail(row)]\n      }), !websiteId && websites.length > 1 && /*#__PURE__*/_jsx(\"div\", {\n        className: styles.website,\n        children: (_getWebsite2 = getWebsite(row)) === null || _getWebsite2 === void 0 ? void 0 : _getWebsite2.domain\n      })]\n    });\n  };\n\n  return /*#__PURE__*/_jsxs(\"div\", {\n    className: styles.table,\n    children: [/*#__PURE__*/_jsx(FilterButtons, {\n      buttons: buttons,\n      selected: filter,\n      onClick: setFilter\n    }), /*#__PURE__*/_jsx(\"div\", {\n      className: styles.header,\n      children: /*#__PURE__*/_jsx(FormattedMessage, {\n        id: \"label.realtime-logs\",\n        defaultMessage: \"Realtime logs\"\n      })\n    }), /*#__PURE__*/_jsxs(\"div\", {\n      className: styles.body,\n      children: [(logs === null || logs === void 0 ? void 0 : logs.length) === 0 && /*#__PURE__*/_jsx(NoData, {}), (logs === null || logs === void 0 ? void 0 : logs.length) > 0 && /*#__PURE__*/_jsx(FixedSizeList, {\n        height: 400,\n        itemCount: logs.length,\n        itemSize: 40,\n        children: Row\n      })]\n    })]\n  });\n}","map":null,"metadata":{},"sourceType":"module"}