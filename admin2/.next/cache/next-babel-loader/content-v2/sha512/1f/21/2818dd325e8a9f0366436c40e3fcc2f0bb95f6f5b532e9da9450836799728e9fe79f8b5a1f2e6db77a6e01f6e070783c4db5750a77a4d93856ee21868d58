{"ast":null,"code":"import { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-runtime\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport React, { useState, useRef, useEffect } from 'react';\nimport classNames from 'classnames';\nimport ChartJS from 'chart.js';\nimport Legend from 'components/metrics/Legend';\nimport { formatLongNumber } from 'lib/format';\nimport { dateFormat } from 'lib/date';\nimport useLocale from 'hooks/useLocale';\nimport useTheme from 'hooks/useTheme';\nimport { DEFAUL_CHART_HEIGHT, DEFAULT_ANIMATION_DURATION, THEME_COLORS } from 'lib/constants';\nimport styles from './BarChart.module.css';\nimport ChartTooltip from './ChartTooltip';\nimport useForceUpdate from '../../hooks/useForceUpdate';\nexport default function BarChart({\n  chartId,\n  datasets,\n  unit,\n  records,\n  height = DEFAUL_CHART_HEIGHT,\n  animationDuration = DEFAULT_ANIMATION_DURATION,\n  className,\n  stacked = false,\n  loading = false,\n  onCreate = () => {},\n  onUpdate = () => {}\n}) {\n  const canvas = useRef();\n  const chart = useRef();\n  const {\n    0: tooltip,\n    1: setTooltip\n  } = useState(null);\n  const {\n    locale\n  } = useLocale();\n  const [theme] = useTheme();\n  const forceUpdate = useForceUpdate();\n  const colors = {\n    text: THEME_COLORS[theme].gray700,\n    line: THEME_COLORS[theme].gray200,\n    zeroLine: THEME_COLORS[theme].gray500\n  };\n\n  function renderXLabel(label, index, values) {\n    if (loading) return '';\n    const d = new Date(values[index].value);\n    const sw = canvas.current.width / window.devicePixelRatio;\n\n    switch (unit) {\n      case 'minute':\n        return index % 2 === 0 ? dateFormat(d, 'H:mm', locale) : '';\n\n      case 'hour':\n        return dateFormat(d, 'p', locale);\n\n      case 'day':\n        if (records > 25) {\n          if (sw <= 275) {\n            return index % 10 === 0 ? dateFormat(d, 'M/d', locale) : '';\n          }\n\n          if (sw <= 550) {\n            return index % 5 === 0 ? dateFormat(d, 'M/d', locale) : '';\n          }\n\n          if (sw <= 700) {\n            return index % 2 === 0 ? dateFormat(d, 'M/d', locale) : '';\n          }\n\n          return dateFormat(d, 'MMM d', locale);\n        }\n\n        if (sw <= 375) {\n          return index % 2 === 0 ? dateFormat(d, 'MMM d', locale) : '';\n        }\n\n        if (sw <= 425) {\n          return dateFormat(d, 'MMM d', locale);\n        }\n\n        return dateFormat(d, 'EEE M/d', locale);\n\n      case 'month':\n        if (sw <= 330) {\n          return index % 2 === 0 ? dateFormat(d, 'MMM', locale) : '';\n        }\n\n        return dateFormat(d, 'MMM', locale);\n\n      default:\n        return label;\n    }\n  }\n\n  function renderYLabel(label) {\n    return +label > 1000 ? formatLongNumber(label) : label;\n  }\n\n  function renderTooltip(model) {\n    const {\n      opacity,\n      title,\n      body,\n      labelColors\n    } = model;\n\n    if (!opacity || !title) {\n      setTooltip(null);\n      return;\n    }\n\n    const [label, value] = body[0].lines[0].split(':');\n    setTooltip({\n      title: dateFormat(new Date(+title[0]), getTooltipFormat(unit), locale),\n      value,\n      label,\n      labelColor: labelColors[0].backgroundColor\n    });\n  }\n\n  function getTooltipFormat(unit) {\n    switch (unit) {\n      case 'hour':\n        return 'EEE p â€” PPP';\n\n      default:\n        return 'PPPP';\n    }\n  }\n\n  function createChart() {\n    const options = {\n      animation: {\n        duration: animationDuration\n      },\n      tooltips: {\n        enabled: false,\n        custom: renderTooltip\n      },\n      hover: {\n        animationDuration: 0\n      },\n      responsive: true,\n      responsiveAnimationDuration: 0,\n      maintainAspectRatio: false,\n      legend: {\n        display: false\n      },\n      scales: {\n        xAxes: [{\n          type: 'time',\n          distribution: 'series',\n          time: {\n            unit,\n            tooltipFormat: 'x'\n          },\n          ticks: {\n            callback: renderXLabel,\n            minRotation: 0,\n            maxRotation: 0,\n            fontColor: colors.text,\n            autoSkipPadding: 1\n          },\n          gridLines: {\n            display: false\n          },\n          offset: true,\n          stacked: true\n        }],\n        yAxes: [{\n          ticks: {\n            callback: renderYLabel,\n            beginAtZero: true,\n            fontColor: colors.text\n          },\n          gridLines: {\n            color: colors.line,\n            zeroLineColor: colors.zeroLine\n          },\n          stacked\n        }]\n      }\n    };\n    onCreate(options);\n    chart.current = new ChartJS(canvas.current, {\n      type: 'bar',\n      data: {\n        datasets\n      },\n      options\n    });\n  }\n\n  function updateChart() {\n    const {\n      options\n    } = chart.current;\n    options.legend.labels.fontColor = colors.text;\n    options.scales.xAxes[0].time.unit = unit;\n    options.scales.xAxes[0].ticks.callback = renderXLabel;\n    options.scales.xAxes[0].ticks.fontColor = colors.text;\n    options.scales.yAxes[0].ticks.fontColor = colors.text;\n    options.scales.yAxes[0].ticks.precision = 0;\n    options.scales.yAxes[0].gridLines.color = colors.line;\n    options.scales.yAxes[0].gridLines.zeroLineColor = colors.zeroLine;\n    options.animation.duration = animationDuration;\n    options.tooltips.custom = renderTooltip;\n    onUpdate(chart.current);\n    chart.current.update();\n    forceUpdate();\n  }\n\n  useEffect(() => {\n    if (datasets) {\n      if (!chart.current) {\n        createChart();\n      } else {\n        setTooltip(null);\n        updateChart();\n      }\n    }\n  }, [datasets, unit, animationDuration, locale, theme]);\n  return /*#__PURE__*/_jsxs(_Fragment, {\n    children: [/*#__PURE__*/_jsx(\"div\", {\n      \"data-tip\": \"\",\n      \"data-for\": `${chartId}-tooltip`,\n      className: classNames(styles.chart, className),\n      style: {\n        height\n      },\n      children: /*#__PURE__*/_jsx(\"canvas\", {\n        ref: canvas\n      })\n    }), /*#__PURE__*/_jsx(Legend, {\n      chart: chart.current\n    }), /*#__PURE__*/_jsx(ChartTooltip, {\n      chartId: chartId,\n      tooltip: tooltip\n    })]\n  });\n}","map":null,"metadata":{},"sourceType":"module"}